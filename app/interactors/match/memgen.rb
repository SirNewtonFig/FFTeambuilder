class Match::MemgenContext < ActiveInteractor::Context::Base
  attributes :team_a, :team_b, :title
  attribute :block, default: -> { [] }

  validates :team_a, :team_b, :title, presence: true
end

class Match::Memgen < ActiveInteractor::Base
  TEXT_ENCODINGS = {
    "0" => '00',
    "1" => '01',
    "2" => '02',
    "3" => '03',
    "4" => '04',
    "5" => '05',
    "6" => '06',
    "7" => '07',
    "8" => '08',
    "9" => '09',
    "A" => '0A',
    "B" => '0B',
    "C" => '0C',
    "D" => '0D',
    "E" => '0E',
    "F" => '0F',
    "G" => '10',
    "H" => '11',
    "I" => '12',
    "J" => '13',
    "K" => '14',
    "L" => '15',
    "M" => '16',
    "N" => '17',
    "O" => '18',
    "P" => '19',
    "Q" => '1A',
    "R" => '1B',
    "S" => '1C',
    "T" => '1D',
    "U" => '1E',
    "V" => '1F',
    "W" => '20',
    "X" => '21',
    "Y" => '22',
    "Z" => '23',
    "a" => '24',
    "b" => '25',
    "c" => '26',
    "d" => '27',
    "e" => '28',
    "f" => '29',
    "g" => '2A',
    "h" => '2B',
    "i" => '2C',
    "j" => '2D',
    "k" => '2E',
    "l" => '2F',
    "m" => '30',
    "n" => '31',
    "o" => '32',
    "p" => '33',
    "q" => '34',
    "r" => '35',
    "s" => '36',
    "t" => '37',
    "u" => '38',
    "v" => '39',
    "w" => '3A',
    "x" => '3B',
    "y" => '3C',
    "z" => '3D',
    "!" => '3E',
    "?" => '40',
    "+" => '42',
    "'" => '93',
    "-" => 'D11D',
    "." => 'D9B6',
    " " => 'fa'
  }

  delegate :team_a, :team_b, :title, :block, to: :context

  def perform
    serialize_id!
    serialize_static_crap!
    serialize_title!
    serialize_more_static_crap!
    8.times { serialize_blank_unit! }
    serialize_teams!
    4.times { serialize_blank_unit! }
    serialize_footer_crap!
  end

  private

    def pad!(byte, n = 1)
      n.times do
        block << byte
      end
    end

    def serialize_id!
      block << '53431101'
    end

    def serialize_static_crap!
      block << '826582658273814082658268826B8264824F82508140824F824F8146825082518146825082560000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF'
      block << '00000000000000000000000000000000000000000000000000000000'
      block << '9546323A6C51CF451B47DA32792A5B67FC4A9A423732D52592252E1DEA18C7186C5AA665BACCCBDD664C668AB6CBDDDC656B64DA65BBEC1D55BA65D6CDB6EC1E4B9C5CBBAAACECCD51AD6BDD91CBCDDCB0DE6AF987CBDADC10FB99E888BA1AD100B1888888A90DE10090888888E901D100B0888898DA01C100008A8A98C911BC0000B188C9A9BDB6000010EEBCA9EFB60010EEDBAB99CEBE102322BFAD996DEC00'
    end

    def serialize_title!
      chars = title
        .chars
        .map{|c| TEXT_ENCODINGS[c] }
        .join

      block << chars.first(32)

      pad!('FA', 16 - chars.length/2)

      block << 'FE'
    end

    def serialize_more_static_crap!
      block << '00645A031604EE6AD40498E0D4F500000000'
      block << '000000000000000000000000000000000000000000000000000000000000000000008062000064CB3611000000FEB24DE408201B00'
      block << '000000000000000000000000000000000000'
      block << '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
      block << '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FF'
      block << 'BC0B0D8000000000000000000000000000000000000010000000FFFF0000FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000BC0B0D8000000000000000000000000000000000000010000000FFFF0000FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000BC0B0D8000000000000000000000000000000000000000000000FFFF0000FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000BC0B0D8000000000000000000000000000000000000000000000FFFF0000FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000BC0B0D8000000000000000000000000000000000000010000000FFFF0000FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000'
      block << '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
      block << '121212121F27283B031E26501337173A1B37393D4F2320211A1436251013261A3244132C391D15173125131B2814171243251A1F17171716171717171737173700'
      block << '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFF'
    end

    def serialize_blank_unit!
      block << '80FF4A0080000000000000000000FFFFFFFFFFFFFF632300005AB41F00540B3A0102023D02AAAA01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000888888888888888888880F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F270F27FEFEFEFEFEFEFEFEFEFEFEFEFEFEFEFE000000000000000000000000000000000000'
    end

    def serialize_teams!
      block << Team::Memgen.perform(team: team_a, palette: palette_a, player: 0).block.join
      block << Team::Memgen.perform(team: team_b, palette: palette_b, player: 1).block.join
    end

    def serialize_footer_crap!
      block << '50505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
      block << '010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000E007000000FDFF00E007002E010000000E000000000000001000000000000000800000000000000300000000000000000000000000000000000000000000000000000000000000E6320000000000005A000000030000000F00000016000000760100007600000001000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000005000000000000000000000000000000000000002E02000000000000000000007300000000000000000000000000000000000000010000000100000000000000000000000000000000000000780000000000000002000000000000000200000000000000000000000000000001000000350000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000093803604000000000000040000000000000000000000000000000000000000000000F00700F0FFFFFFFFFFFFFF0F000040000000000000000000000000200000000000000000000000187000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000076464344333323C1230002402003CC03022023021313C1302232000000000010'
      block << '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
      block << '000000004886A822C5000102030405060708090AFFFF01000204050709FFFF000102030405FF00010205FF00010205FF000102030405FF00010205FF8F8E8D8C8783797877767574737271706E6C6B6A6968676564636261605E5D5C5B5A565554535251504F4E4C4B4A49464544434241403F3E3A39373231302F2E2D2C2B2A29282726252421201F1E1A19171211100E0D0C0B0A090807060522590F888B2366861D6F8A8958571C1B6D48383D5F18473C3504858480168281363403154D143B33130201FF'
      block << 'ABA9A69C9B98979390A8A799A59AA3A4AA94A2A0A19695929F9E919DFFCFC7C5C2B9B7B4B0ACC6B8CEB6B3CDB5C4C3CCCBC0C1BFBECABDB2B1AFC9AEBCC8BBADBAFFEFEEEDECEBEAE9E5DEDDDBD8D1DFD2D3E1E2E6E3D4DAD5E8D9D6E0E4DCE7D7D0FFF1F07F7E7D7B7A7CFDFCFBFAF9F8F7F6F5F4F3F2FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
      block << '0000000000000000000000000000000000000000'
    end

    def palette_a
      Team.palette_as[team_a.palette_a]
    end

    def palette_b
      return Team.palette_bs[team_b.palette_a] unless team_b.palette_a == team_a.palette_a

      Team.palette_bs[team_b.palette_b]
    end
end
